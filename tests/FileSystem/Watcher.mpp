export module CppUtils.UnitTests.FileSystem.Watcher;

import std;
import CppUtils;

export namespace CppUtils::UnitTest::FileSystem::Watcher
{
	inline auto _ = TestSuite{"FileSystem/Watcher", [](auto& suite) {
		using namespace std::chrono_literals;
		using Logger = CppUtils::Logger<"CppUtils">;

		suite.addTest("No file", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto watcher = CppUtils::FileSystem::Watcher{};
				watcher.watch(directory / "test.tmp");
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Created,
					[&suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					Logger::print("{}\n", filePath.string());
					suite.expect(false);
				});
				std::this_thread::sleep_for(10ms);
			}};
		});
		/*
		suite.addTest("No event", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto watcher = CppUtils::FileSystem::Watcher{};
				auto filePath = directory / "test.tmp";
				CppUtils::FileSystem::String::write(filePath, "Hello World!");
				watcher.watch(filePath);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Created,
					[&suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					Logger::print("{}\n", filePath.string());
					suite.expect(false);
				});
				std::this_thread::sleep_for(10ms);
			}};
		});

		suite.addTest("Watch file creation", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto eventsTriggered = 0uz;
				auto watcher = CppUtils::FileSystem::Watcher{};
				auto filePath = directory / "test.tmp";

				watcher.watch(filePath);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Created,
					[&eventsTriggered, &suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					++eventsTriggered;
					Logger::print("{}\n", filePath.string());
					suite.expectEqual(event, CppUtils::FileSystem::Watcher::Event::Created);
				});

				CppUtils::FileSystem::String::write(filePath, "Hello World!");
				std::this_thread::sleep_for(10ms);

				suite.expectEqual(eventsTriggered, 1uz);
			}};
		});

		suite.addTest("Watch file modification", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto eventsTriggered = 0uz;
				auto watcher = CppUtils::FileSystem::Watcher{};
				auto filePath = directory / "test.tmp";
				CppUtils::FileSystem::String::write(filePath, "Foo");

				watcher.watch(filePath);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Modified,
					[&eventsTriggered, &suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					++eventsTriggered;
					Logger::print("{}\n", filePath.string());
					suite.expectEqual(event, CppUtils::FileSystem::Watcher::Event::Modified);
				});

				std::this_thread::sleep_for(10ms);
				CppUtils::FileSystem::String::write(filePath, "Bar");
				std::this_thread::sleep_for(10ms);

				suite.expectEqual(eventsTriggered, 1uz);
			}};
		});

		suite.addTest("Watch file deletion", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto eventsTriggered = 0uz;
				auto watcher = CppUtils::FileSystem::Watcher{};
				auto filePath = directory / "test.tmp";
				CppUtils::FileSystem::String::write(filePath, "Hello World!");

				watcher.watch(filePath);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Deleted,
					[&eventsTriggered, &suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					++eventsTriggered;
					Logger::print("{}\n", filePath.string());
					suite.expectEqual(event, CppUtils::FileSystem::Watcher::Event::Deleted);
				});

				std::filesystem::remove(filePath);
				std::this_thread::sleep_for(10ms);

				suite.expectEqual(eventsTriggered, 1uz);
			}};
		});

		suite.addTest("Watch directory creation", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto eventsTriggered = 0uz;
				auto watcher = CppUtils::FileSystem::Watcher{};

				watcher.watch(directory);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Created,
					[&eventsTriggered, &suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					++eventsTriggered;
					Logger::print("{}\n", filePath.string());
					suite.expectEqual(event, CppUtils::FileSystem::Watcher::Event::Created);
				});

				std::this_thread::sleep_for(10ms);
				CppUtils::FileSystem::String::write(directory / "test.tmp", "Hello World!");
				std::this_thread::sleep_for(10ms);

				suite.expectEqual(eventsTriggered, 1uz);
			}};
		});

		suite.addTest("Watch directory modification", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto eventsTriggered = 0uz;
				auto watcher = CppUtils::FileSystem::Watcher{};
				auto filePath = directory / "test.tmp";
				CppUtils::FileSystem::String::write(filePath, "Foo");

				watcher.watch(directory);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Modified,
					[&eventsTriggered, &suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					++eventsTriggered;
					Logger::print("{}\n", filePath.string());
					suite.expectEqual(event, CppUtils::FileSystem::Watcher::Event::Modified);
				});

				std::this_thread::sleep_for(10ms);
				CppUtils::FileSystem::String::write(filePath, "Bar");
				std::this_thread::sleep_for(10ms);

				suite.expectEqual(eventsTriggered, 1uz);
			}};
		});

		suite.addTest("Watch directory deletion", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				auto eventsTriggered = 0uz;
				auto watcher = CppUtils::FileSystem::Watcher{};
				auto filePath = directory / "test.tmp";
				CppUtils::FileSystem::String::write(filePath, "Hello World!");

				watcher.watch(directory);
				watcher.onEvent(CppUtils::FileSystem::Watcher::Event::Deleted,
					[&eventsTriggered, &suite](const std::filesystem::path& filePath,
						[[maybe_unused]] CppUtils::FileSystem::Watcher::Event event) -> void {
					++eventsTriggered;
					Logger::print("{}\n", filePath.string());
					suite.expectEqual(event, CppUtils::FileSystem::Watcher::Event::Deleted);
				});

				std::this_thread::sleep_for(10ms);
				std::filesystem::remove(filePath);
				std::this_thread::sleep_for(10ms);

				suite.expectEqual(eventsTriggered, 1uz);
			}};
		});
		*/
	}};
}
