export module CppUtils.UnitTests.LogRotate;

import std;
import CppUtils;

namespace CppUtils::UnitTest::LogRotate
{
	auto _ = TestSuite{"LogRotate", {"Logger", "FileSystem/Directory"}, [](TestSuite& suite) {
		using namespace std::literals;

		suite.addTest("Log Rotation", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				const auto logPath = directory / "file.log";
				CppUtils::Log::addFileSink<"TestRotate">(LogRotateOptions{
					.filePath = logPath,
					.maxFiles = 10,
					.maxSize = 10});

				CppUtils::Logger<"TestRotate">::print("First message");
				CppUtils::Logger<"TestRotate">::waitUntilFinished();

				suite.expect(std::filesystem::exists(logPath));

				CppUtils::Logger<"TestRotate">::print("Second message"); // Triggers rotation
				CppUtils::Logger<"TestRotate">::waitUntilFinished();

				const auto secondFilePath = directory / "file1.log";
				suite.expect(std::filesystem::exists(secondFilePath));
				suite.expect(std::filesystem::exists(logPath));
				suite.expectEqual(CppUtils::FileSystem::String::read(secondFilePath), "First message"s);
				suite.expectEqual(CppUtils::FileSystem::String::read(logPath), "Second message"s);
			}};
		});

		suite.addTest("Full Log Rotation", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) -> void {
				const auto logPath = directory / "file.log";
				CppUtils::Log::addFileSink<"TestFullRotate">(LogRotateOptions{
					.filePath = logPath,
					.maxFiles = 3,
					.maxSize = 10});

				const auto longString = "This is a long string to exceed the max size"s;

				CppUtils::Logger<"TestFullRotate">::print("{}", longString);
				CppUtils::Logger<"TestFullRotate">::waitUntilFinished();

				suite.expect(std::filesystem::exists(logPath));

				CppUtils::Logger<"TestFullRotate">::print("{}", longString); // Triggers rotation
				CppUtils::Logger<"TestFullRotate">::waitUntilFinished();

				suite.expect(std::filesystem::exists(logPath));
				suite.expect(std::filesystem::exists(directory / "file1.log"));

				CppUtils::Logger<"TestFullRotate">::print("{}", longString); // Triggers rotation
				CppUtils::Logger<"TestFullRotate">::waitUntilFinished();

				suite.expect(std::filesystem::exists(logPath));
				suite.expect(std::filesystem::exists(directory / "file1.log"));
				suite.expect(std::filesystem::exists(directory / "file2.log"));

				CppUtils::Logger<"TestFullRotate">::print("{}", longString); // Triggers rotation
				CppUtils::Logger<"TestFullRotate">::waitUntilFinished();

				suite.expect(std::filesystem::exists(logPath));
				suite.expect(std::filesystem::exists(directory / "file1.log"));
				suite.expect(std::filesystem::exists(directory / "file2.log"));
				suite.expect(not std::filesystem::exists(directory / "file3.log"));
			}};
		});
	}};
}
