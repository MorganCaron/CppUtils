export module CppUtils.UnitTests.Language.CSV.Mapping;

import std;
import CppUtils;

namespace CppUtils::UnitTest::Language::CSV::Mapping
{
	struct Object final
	{
		std::string_view a;
		std::string b;
		std::size_t c;
		int d;
		float e;

		auto operator==(const Object&) const -> bool = default;
	};

	struct FileObject final
	{
		std::string a;
		std::string b;
		std::size_t c;
		int d;
		float e;

		auto operator==(const FileObject&) const -> bool = default;
	};
}

template<>
struct std::formatter<CppUtils::UnitTest::Language::CSV::Mapping::Object>: std::formatter<std::string>
{
	auto format(const CppUtils::UnitTest::Language::CSV::Mapping::Object& object, format_context& context) const
	{
		return std::formatter<std::string>::format(
			std::format("Object{{a={}, b={}, c={}, d={}, e={}}}", object.a, object.b, object.c, object.d, object.e),
			context);
	}
};

template<>
struct std::formatter<CppUtils::UnitTest::Language::CSV::Mapping::FileObject>: std::formatter<std::string>
{
	auto format(const CppUtils::UnitTest::Language::CSV::Mapping::FileObject& fileObject, format_context& context) const
	{
		return std::formatter<std::string>::format(
			std::format("FileObject{{a={}, b={}, c={}, d={}, e={}}}", fileObject.a, fileObject.b, fileObject.c, fileObject.d, fileObject.e),
			context);
	}
};

namespace CppUtils::UnitTest::Language::CSV::Mapping
{
	using namespace CppUtils::String::Literals;

	using CSVMapping = CppUtils::Type::Mapping<
		CppUtils::Type::Pair<"String 1"_token, "A"_excelColumn>,
		CppUtils::Type::Pair<"String 2"_token, "B"_excelColumn>,
		CppUtils::Type::Pair<"Unsigned integer"_token, "C"_excelColumn>,
		CppUtils::Type::Pair<"Signed integer"_token, "D"_excelColumn>,
		CppUtils::Type::Pair<"Floating point"_token, "E"_excelColumn>>;

	using StructMapping = CppUtils::Type::Mapping<
		CppUtils::Type::Pair<"String 1"_token, &Object::a>,
		CppUtils::Type::Pair<"String 2"_token, &Object::b>,
		CppUtils::Type::Pair<"Unsigned integer"_token, &Object::c>,
		CppUtils::Type::Pair<"Signed integer"_token, &Object::d>,
		CppUtils::Type::Pair<"Floating point"_token, &Object::e>>;

	using FileStructMapping = CppUtils::Type::Mapping<
		CppUtils::Type::Pair<"String 1"_token, &FileObject::a>,
		CppUtils::Type::Pair<"String 2"_token, &FileObject::b>,
		CppUtils::Type::Pair<"Unsigned integer"_token, &FileObject::c>,
		CppUtils::Type::Pair<"Signed integer"_token, &FileObject::d>,
		CppUtils::Type::Pair<"Floating point"_token, &FileObject::e>>;

	struct ObjectMapping final
	{
		using CSVMapping = UnitTest::Language::CSV::Mapping::CSVMapping;
		using StructMapping = UnitTest::Language::CSV::Mapping::StructMapping;
		using FunctionMapping = CppUtils::Type::Mapping<>;
	};

	struct FileMapping final
	{
		using CSVMapping = UnitTest::Language::CSV::Mapping::CSVMapping;
		using StructMapping = UnitTest::Language::CSV::Mapping::FileStructMapping;
		using FunctionMapping = CppUtils::Type::Mapping<>;
	};

	struct MultiplyBy final
	{
		std::size_t factor;
		inline auto operator()(auto& member, std::string_view value) const -> void
		{
			std::from_chars(std::data(value), std::data(value) + std::size(value), member);
			member *= factor;
		}
	};

	auto _ = TestSuite{"Language/CSV/Mapping", {"FileSystem/Directory", "Language/CSV/Parsing"}, [](TestSuite& suite) {
		using namespace std::literals;
		using namespace CppUtils::Language::CSV::Literals;

		suite.addTest("CSV line to Struct", [&] {
			const auto csvLine = "foo;bar;42;-1;3.14"_csv[0];

			const auto object = CppUtils::Language::CSV::toStruct<Object, ObjectMapping>(csvLine);

			suite.expectEqual(object, Object{"foo", "bar", 42, -1, 3.14f});
		});

		suite.addTest("CSV to Structs", [&] {
			const auto objects = CppUtils::Language::CSV::toStructs<Object, ObjectMapping>(R"(
					a;b;c;d;e
					foo;bar;42;-1;3.14
				)"_csv,
				1uz);

			suite.expectEqual(objects, std::vector<Object>{{"foo", "bar", 42, -1, 3.14f}});
		});

		suite.addTest("Struct to CSV line", [&] {
			const auto object = Object{"foo", "bar", 42, -1, 3.14f};

			const auto csvLine = CppUtils::Language::CSV::toCSV<Object, ObjectMapping>(object);

			suite.expectEqual(csvLine, "foo;bar;42;-1;3.14"s);
		});

		suite.addTest("Structs to CSV", [&] {
			const auto objects = std::vector<Object>{
				{"foo", "bar", 42, -1, 3.14f},
				{"hello", "world", 123, -456, 1.23f}};

			const auto csv = CppUtils::Language::CSV::toCSV<Object, ObjectMapping>(objects);

			suite.expectEqual(CppUtils::Language::CSV::parseCSV(csv), R"(
				foo;bar;42;-1;3.14
				hello;world;123;-456;1.23
			)"_csv);
		});

		suite.addTest("load CSV File", [&] {
			CppUtils::FileSystem::TemporaryDirectory{[&suite](const auto& directory) {
				const auto filePath = directory / "test.csv";
				CppUtils::FileSystem::String::write(filePath, R"(
					a;b;c;d;e
					foo;bar;42;-1;3.14
				)"sv);

				const auto objects = CppUtils::Language::CSV::loadFile<FileObject, FileMapping>(filePath, 1uz);

				suite.expectEqual(objects, std::vector<FileObject>{{"foo", "bar", 42, -1, 3.14f}});
			}};
		});

		suite.addTest("LambdaMapping", [&] {
			struct LambdaMapping final
			{
				using CSVMapping = UnitTest::Language::CSV::Mapping::CSVMapping;
				using StructMapping = UnitTest::Language::CSV::Mapping::StructMapping;
				using FunctionMapping = CppUtils::Type::Mapping<
					CppUtils::Type::Pair<"Unsigned integer"_token, [](auto& member, std::string_view value) {
					std::from_chars(std::data(value), std::data(value) + std::size(value), member);
					member *= 2;
				}>>;
			};

			const auto csvLine = "foo;bar;21;-1;3.14"_csv[0];

			const auto object = CppUtils::Language::CSV::toStruct<Object, LambdaMapping>(csvLine);

			suite.expectEqual(object, Object{"foo", "bar", 42, -1, 3.14f});
		});

		suite.addTest("FunctorMapping", [&] {
			struct FunctorMapping final
			{
				using CSVMapping = UnitTest::Language::CSV::Mapping::CSVMapping;
				using StructMapping = UnitTest::Language::CSV::Mapping::StructMapping;
				using FunctionMapping = CppUtils::Type::Mapping<
					CppUtils::Type::Pair<"Unsigned integer"_token, MultiplyBy{2uz}>>;
			};

			const auto csvLine = "foo;bar;21;-1;3.14"_csv[0];

			const auto object = CppUtils::Language::CSV::toStruct<Object, FunctorMapping>(csvLine);

			suite.expectEqual(object, Object{"foo", "bar", 42, -1, 3.14f});
		});
	}};
}
