export module CppUtils.UnitTests.Pattern;

import std;
import CppUtils;

namespace CppUtils::UnitTest::Pattern
{
	struct TestClass final
	{
		int value = 0;
	};

	auto _ = TestSuite{"Pattern", {"UnitTest"}, [](TestSuite& suite) {
		suite.addTest("Singleton", [&] {
			auto& instance1 = CppUtils::Pattern::Singleton<TestClass>::get();
			auto& instance2 = CppUtils::Pattern::Singleton<TestClass>::get();

			instance1.value = 42;
			suite.expectEqual(instance2.value, 42);
			suite.expectEqual(std::addressof(instance1), std::addressof(instance2));
		});

		suite.addTest("Multiton", [&] {
			constexpr auto keyA = 1;
			constexpr auto keyB = 2;

			auto& instanceA = CppUtils::Pattern::Multiton<TestClass, keyA>::get();
			auto& instanceB = CppUtils::Pattern::Multiton<TestClass, keyB>::get();
			auto& instanceA2 = CppUtils::Pattern::Multiton<TestClass, keyA>::get();

			instanceA.value = 10;
			instanceB.value = 20;

			suite.expectEqual(instanceA.value, 10);
			suite.expectEqual(instanceB.value, 20);
			suite.expectEqual(instanceA2.value, 10);
			suite.expectEqual(std::addressof(instanceA), std::addressof(instanceA2));
			suite.expect(std::addressof(instanceA) != std::addressof(instanceB));
		});
	}};
}
