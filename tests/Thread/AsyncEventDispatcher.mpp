export module CppUtils.UnitTests.Thread.AsyncEventDispatcher;

import std;
import CppUtils;

namespace CppUtils::UnitTest::Thread::AsyncEventDispatcher
{
	auto _ = TestSuite{"Thread/AsyncEventDispatcher", {"Thread/ThreadPool", "Execution/EventDispatcher"}, [](TestSuite& suite) {
		suite.addTest("Emit and Wait", [&] {
			auto dispatcher = CppUtils::Thread::AsyncEventDispatcher{};
			auto received = std::atomic_bool{false};

			dispatcher.subscribe<"Event">([&](bool value) {
				suite.expectEqual(value, true);
				received = true;
			});
			dispatcher.emit<"Event">(true);

			dispatcher.waitUntilFinished();
			suite.expect(received);
		});

		suite.addTest("Error Handling", [&] {
			auto errorCaught = std::atomic_bool{false};
			auto onError = [&](std::exception_ptr) {
				errorCaught = true;
			};
			auto dispatcher = CppUtils::Thread::AsyncEventDispatcher{1, onError};

			dispatcher.subscribe<"Event">([&](std::nullptr_t) {
				throw std::runtime_error{"Test Error"};
			});
			dispatcher.emit<"Event">(nullptr);

			dispatcher.waitUntilFinished();
			suite.expect(errorCaught);
		});

		suite.addTest("Stateful lambda", [&] {
			auto dispatcher = CppUtils::Thread::AsyncEventDispatcher{};
			auto counter = std::make_shared<int>(0);
			auto mutex = std::make_shared<std::mutex>();

			dispatcher.subscribe<"Event">([counter, mutex, internalCount = 0](int value) mutable {
				auto lockGuard = std::lock_guard{*mutex};
				internalCount += value;
				*counter = internalCount;
			});
			dispatcher.emit<"Event">(10);
			dispatcher.emit<"Event">(20);

			dispatcher.waitUntilFinished();
			suite.expectEqual(*counter, 30);
		});

		suite.addTest("Passing stateful lambda as argument", [&] {
			auto dispatcher = CppUtils::Thread::AsyncEventDispatcher{};
			auto result = std::atomic_int{0};

			using Function = std::function<void()>;
			dispatcher.subscribe<"Execute">([&](Function function) {
				function();
			});

			dispatcher.emit<"Execute">(Function{[state = 42, &result]() {
				result = state;
			}});

			dispatcher.waitUntilFinished();
			suite.expectEqual(result.load(), 42);
		});
	}};
}
