export module CppUtils.UnitTests.Thread.AsyncEventDispatcher;

import std;
import CppUtils;

export namespace CppUtils::UnitTest::Thread::AsyncEventDispatcher
{
	inline auto _ = TestSuite{"Thread/AsyncEventDispatcher", {"Thread/ThreadPool", "Execution/EventDispatcher"}, [](auto& suite) {
		suite.addTest("Emit and Wait", [&] {
			auto dispatcher = CppUtils::Thread::AsyncEventDispatcher{};
			std::atomic_bool received = false;

			dispatcher.subscribe<"Event">([&](bool value) {
				suite.expectEqual(value, true);
				received = true;
			});
			dispatcher.emit<"Event">(true);

			dispatcher.waitUntilFinished();
			suite.expect(received);
		});

		suite.addTest("Error Handling", [&] {
			std::atomic_bool errorCaught = false;
			auto onError = [&](std::exception_ptr) {
				errorCaught = true;
			};
			auto dispatcher = CppUtils::Thread::AsyncEventDispatcher{1, onError};

			dispatcher.subscribe<"Event">([&](std::nullptr_t) {
				throw std::runtime_error{"Test Error"};
			});
			dispatcher.emit<"Event">(nullptr);

			dispatcher.waitUntilFinished();
			suite.expect(errorCaught);
		});
	}};
}
