export module CppUtils.UnitTests.System;

import std;
import CppUtils;

export namespace CppUtils::UnitTest::System
{
	inline auto _ = TestSuite{"System", {"UnitTest"}, [](auto& suite) {
		suite.addTest("createSharedMemory", [&] {
			auto fileDescriptor = CppUtils::System::createSharedMemory();
			suite.expect(fileDescriptor.has_value());
			suite.expect(fileDescriptor.value().isValid());
		});

		suite.addTest("allocateSharedMemory", [&] {
			constexpr auto bufferSize = 1'000uz;
			auto fileDescriptor = CppUtils::System::allocateSharedMemory(bufferSize);
			suite.expect(fileDescriptor.has_value());
			suite.expect(fileDescriptor.value().isValid());
		});

		suite.addTest("MappedSharedMemory", [&] {
			constexpr auto bufferSize = 1'000uz;
			auto fileDescriptor = CppUtils::System::allocateSharedMemory(bufferSize);
			[[maybe_unused]] auto mappedSharedMemory = CppUtils::System::MappedSharedMemory(fileDescriptor.value(), bufferSize);
		});

		suite.addTest("MappedSharedMemory copy", [&] {
			constexpr auto bufferSize = 1'000uz;
			auto fileDescriptor = CppUtils::System::allocateSharedMemory(bufferSize);
			auto mappedSharedMemory0 = CppUtils::System::MappedSharedMemory(fileDescriptor.value(), bufferSize);
			[[maybe_unused]] auto mappedSharedMemory1 = std::move(mappedSharedMemory0);
		});
	}};
}
